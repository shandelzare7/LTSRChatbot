# ä½ çš„ Chatbot æµç¨‹å›¾ï¼ˆå¯è§†åŒ–ï¼‰

## ğŸ“Š å®Œæ•´æµç¨‹å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     å¼€å§‹ (ç”¨æˆ·å‘é€æ¶ˆæ¯)                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  safety_check â”‚  â† å®‰å…¨æ£€æµ‹èŠ‚ç‚¹
                    â”‚  (å®‰å…¨æ£€æµ‹)    â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â”‚ æ£€æŸ¥ safety_flag
                            â”‚
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚                               â”‚
            â–¼                               â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ safety_flag   â”‚              â”‚ safety_flag  â”‚
    â”‚   = True      â”‚              â”‚   = False    â”‚
    â”‚  (å®‰å…¨é€šè¿‡)    â”‚              â”‚  (ä¸å®‰å…¨)     â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚                               â”‚
            â”‚                               â”‚
            â–¼                               â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚   planner     â”‚              â”‚     END      â”‚
    â”‚   (è§„åˆ’å™¨)     â”‚              â”‚   (ç»“æŸ)     â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
            â”‚ ç”Ÿæˆ plan ç­–ç•¥
            â”‚
            â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚   generator   â”‚
    â”‚   (ç”Ÿæˆå™¨)     â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
            â”‚ ç”Ÿæˆ final_response
            â”‚
            â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚    evolver    â”‚
    â”‚   (æ¼”åŒ–å™¨)     â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
            â”‚ æ›´æ–° relationship_stats
            â”‚
            â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚     END       â”‚
    â”‚   (ç»“æŸ)       â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ”„ æ•°æ®æµè½¬ï¼ˆState çš„å˜åŒ–ï¼‰

### åˆå§‹çŠ¶æ€
```python
{
    "messages": [HumanMessage("ä½ å¥½")],
    "relationship_stats": {"intimacy": 0},
    "safety_flag": False,
    "plan": "",
    "final_response": ""
}
```

### ç»è¿‡ safety_check å
```python
{
    "messages": [HumanMessage("ä½ å¥½")],
    "relationship_stats": {"intimacy": 0},
    "safety_flag": True,  â† æ›´æ–°äº†ï¼
    "plan": "",
    "final_response": ""
}
```

### ç»è¿‡ planner å
```python
{
    "messages": [HumanMessage("ä½ å¥½")],
    "relationship_stats": {"intimacy": 0},
    "safety_flag": True,
    "plan": "å‹å¥½åˆæ¬¡æ¥è§¦ç­–ç•¥...",  â† æ›´æ–°äº†ï¼
    "final_response": ""
}
```

### ç»è¿‡ generator å
```python
{
    "messages": [HumanMessage("ä½ å¥½")],
    "relationship_stats": {"intimacy": 0},
    "safety_flag": True,
    "plan": "å‹å¥½åˆæ¬¡æ¥è§¦ç­–ç•¥...",
    "final_response": "ä½ å¥½ï¼å¾ˆé«˜å…´è®¤è¯†ä½ ..."  â† æ›´æ–°äº†ï¼
}
```

### ç»è¿‡ evolver åï¼ˆæœ€ç»ˆçŠ¶æ€ï¼‰
```python
{
    "messages": [HumanMessage("ä½ å¥½")],
    "relationship_stats": {
        "intimacy": 5,  â† æ›´æ–°äº†ï¼
        "conversation_count": 1  â† æ›´æ–°äº†ï¼
    },
    "safety_flag": True,
    "plan": "å‹å¥½åˆæ¬¡æ¥è§¦ç­–ç•¥...",
    "final_response": "ä½ å¥½ï¼å¾ˆé«˜å…´è®¤è¯†ä½ ..."
}
```

## ğŸ¯ å…³é”®ç‚¹ç†è§£

### 1. StateGraph çš„ä½œç”¨
- **StateGraph** = çŠ¶æ€å›¾ï¼Œç®¡ç†æ•´ä¸ªæµç¨‹
- å®ƒçŸ¥é“ï¼šæœ‰å“ªäº›èŠ‚ç‚¹ã€èŠ‚ç‚¹ä¹‹é—´çš„è¿æ¥ã€å¦‚ä½•ä¼ é€’çŠ¶æ€

### 2. èŠ‚ç‚¹çš„ä½œç”¨
- æ¯ä¸ªèŠ‚ç‚¹æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œæ¥æ”¶ `state`ï¼Œè¿”å›æ›´æ–°åçš„ `state`
- LangGraph è‡ªåŠ¨è°ƒç”¨è¿™äº›å‡½æ•°ï¼Œå¹¶ä¼ é€’çŠ¶æ€

### 3. æ¡ä»¶è¾¹çš„ä½œç”¨
```python
workflow.add_conditional_edges(
    "safety_check",
    should_continue,  # è¿™ä¸ªå‡½æ•°å†³å®šä¸‹ä¸€æ­¥
    {
        "continue": "planner",  # è¿”å› "continue" å°±å» planner
        "end": END              # è¿”å› "end" å°±ç»“æŸ
    }
)
```

### 4. é¡ºåºè¾¹çš„ä½œç”¨
```python
workflow.add_edge("planner", "generator")
# æ„æ€æ˜¯ï¼šplanner æ‰§è¡Œå®Œåï¼Œè‡ªåŠ¨æ‰§è¡Œ generator
```

## ğŸ’» ä»£ç å¯¹åº”å…³ç³»

| ä»£ç éƒ¨åˆ† | ä½œç”¨ | ç±»æ¯” |
|---------|------|------|
| `StateGraph(AgentState)` | åˆ›å»ºæµç¨‹å›¾ | åˆ›å»ºä¸€å¼ ç©ºç™½çš„æµç¨‹å›¾ |
| `add_node()` | æ·»åŠ å¤„ç†æ­¥éª¤ | åœ¨æµç¨‹å›¾ä¸Šç”»ä¸€ä¸ªæ¡† |
| `set_entry_point()` | è®¾ç½®èµ·ç‚¹ | æ ‡è®°ä»å“ªé‡Œå¼€å§‹ |
| `add_edge()` | æ·»åŠ è¿æ¥çº¿ | ç”»ç®­å¤´ï¼Œè¡¨ç¤ºæ‰§è¡Œé¡ºåº |
| `add_conditional_edges()` | æ·»åŠ æ¡ä»¶åˆ†æ”¯ | ç”»åˆ†å‰ç®­å¤´ï¼Œæ ¹æ®æ¡ä»¶é€‰æ‹© |
| `compile()` | ç¼–è¯‘æˆå¯æ‰§è¡Œç¨‹åº | æŠŠæµç¨‹å›¾å˜æˆå¯è¿è¡Œçš„ç¨‹åº |
| `app.invoke(state)` | æ‰§è¡Œæµç¨‹ | è¿è¡Œç¨‹åºï¼Œä¼ å…¥åˆå§‹æ•°æ® |

## ğŸš€ ä¸ºä»€ä¹ˆéœ€è¦ LangGraphï¼Ÿ

### åœºæ™¯ 1ï¼šæ²¡æœ‰ LangGraph
```python
# æ‰‹åŠ¨æ§åˆ¶ï¼Œä»£ç æ··ä¹±
def process():
    result1 = step1()
    if result1:
        result2 = step2(result1)
        result3 = step3(result2)
        result4 = step4(result3)
        return result4
    else:
        return None
```

### åœºæ™¯ 2ï¼šä½¿ç”¨ LangGraph
```python
# æ¸…æ™°å®šä¹‰æµç¨‹
workflow = StateGraph(State)
workflow.add_node("step1", step1)
workflow.add_node("step2", step2)
workflow.add_node("step3", step3)
workflow.add_node("step4", step4)
workflow.set_entry_point("step1")
workflow.add_conditional_edges("step1", check, {"yes": "step2", "no": END})
workflow.add_edge("step2", "step3")
workflow.add_edge("step3", "step4")
workflow.add_edge("step4", END)
```

**ä¼˜åŠ¿**ï¼š
- âœ… æµç¨‹ä¸€ç›®äº†ç„¶
- âœ… æ˜“äºä¿®æ”¹ï¼ˆæƒ³åŠ æ­¥éª¤ï¼ŸåŠ ä¸ªèŠ‚ç‚¹å°±è¡Œï¼‰
- âœ… çŠ¶æ€è‡ªåŠ¨ç®¡ç†
- âœ… æ”¯æŒå¤æ‚çš„åˆ†æ”¯é€»è¾‘
