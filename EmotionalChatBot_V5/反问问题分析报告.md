# 反问问题分析报告

## 📋 问题概述

从最新三条日志文件分析发现，**每次回复都会出现反问**，导致对话显得过于主动和追问式，影响自然对话体验。

## 🔍 日志分析

### 日志1: `9c3fa3fd-f4e7-4d97-856c-04d1a6dca501_20260217_155201.log`
- **用户输入**: "嗯。同事是我支教学校的幼儿园老师..."
- **Bot回复**: "嫣然一笑"这个名字真的很有诗意！ 听起来你在支教期间有很多有趣的经历呢。**还有其他特别的故事吗？**
- **包含反问**: ✅

### 日志2: `e8504ad2-ac85-4626-af88-de8095c3a0a0_20260217_151529.log`
- **用户输入**: "哈哈我们别再聊歌单了😂 你通勤路上有没有遇到过什么"离谱但好笑"的小事？"
- **8个候选回复全部包含反问**:
  - "你有没有见过类似的事情？"
  - "你最近有没有遇到什么有趣的事情？"
  - "你有没有见过什么有趣的事情？"
  - "你有没有遇到过类似的搞笑场景？"
- **Bot最终回复**: "我可能更偏甜口，像是热乎乎的红豆汤就很不错。**你有没有特别喜欢的甜口小吃？**"
- **包含反问**: ✅

### 日志3: `b3ec870e-02c2-4ebf-8566-8c568c7314f6_20260217_150600.log`
- **用户输入**: "鹅块"
- **8个候选回复全部包含反问**:
  - "你是想吃鹅肉吗？"
  - "你是想尝试新菜式吗？"
  - "你平时喜欢尝试新菜吗？"
  - "是你们家过年的特色菜吗？"
- **Bot最终回复**: "做手工是个很好的主意！可以让家人一起参与，增添互动和乐趣。**你有想过做什么样的手工吗？**"
- **包含反问**: ✅

## 🔎 代码层面原因分析

### 1. **mode_behavior_targets 配置过于强调提问**

**位置**: `config/modes/normal_mode.yaml:21`
```yaml
notes:
  - 内容要对齐用户问题与当前话题，不要自顾自扩写。
  - 若信息不足，优先提出1个澄清问题而不是长篇建议。
```

**问题**: 这条规则被 LLM 过度解读，即使信息充足时也会添加反问。

### 2. **stage_targets 的 allowed_acts 包含 question**

**位置**: `app/lats/requirements.py:248-252`
```python
"initiating": (
    ["answer", "clarify", "question", "light_tease", "small_talk"],
    ["deep_probe", "commitment_push", "intimacy_escalate"],
),
"experimenting": (
    ["answer", "clarify", "question", "light_tease", "small_talk"],
    ["commitment_push", "intimacy_escalate"],
),
```

**问题**: `question` 在 allowed_acts 中，LLM 认为这是"允许且推荐"的行为。

### 3. **reply_planner prompt 中明确提到反问**

**位置**: `app/lats/reply_planner.py:78`
```python
关键：不是把长文本随便切碎；而是把"先回应/先态度或结论 → 再补充/解释/反问/边界/收束"等动作安排成合理节奏。
```

**问题**: Prompt 中把"反问"作为合理的对话动作之一，强化了 LLM 使用反问的倾向。

### 4. **stage 策略鼓励提问**

**位置**: `config/stages/experimenting.yaml:12-15`
```yaml
strategy:
  - 互惠性自我表露：在问用户问题前，先分享一个低风险、可重复的生活小细节/小偏好
  - 兴趣嗅探：抛出 2-3 个不同方向的话题（比如电影、旅行、吐槽），看用户接哪个
  - 风格：轻松、跳跃、像打乒乓球一样有来有回
```

**问题**: "兴趣嗅探"策略鼓励提问，但 LLM 可能过度使用。

### 5. **ReplyMsgFunction 中 question 是标准类型**

**位置**: `app/state.py:197`
```python
ReplyMsgFunction = Literal[
    "empathy",      # 共情/安抚
    "stance",       # 站队/态度
    "answer",       # 直接回应/结论
    "explain",      # 解释原因/背景
    "advice",       # 给建议/行动
    "boundary",     # 边界/拒绝
    "question",     # 反问/追问
    "closing",      # 收束/邀约继续
]
```

**问题**: `question` 作为标准消息类型，在系统设计中是"一等公民"，容易被频繁使用。

## 💡 根本原因总结

1. **多重强化**: 多个配置层（mode、stage、prompt）都在鼓励或允许提问
2. **缺乏限制**: 没有明确的"何时不应该提问"的规则
3. **过度解读**: LLM 将"优先提问"理解为"必须提问"
4. **缺乏上下文判断**: 没有根据用户输入是否完整来判断是否需要提问

## 🛠️ 解决方案建议

### 方案1: 修改 mode_behavior_targets（推荐）
**文件**: `config/modes/normal_mode.yaml`
```yaml
notes:
  - 内容要对齐用户问题与当前话题，不要自顾自扩写。
  - 若信息不足且用户明确询问时，可提出1个澄清问题；否则优先回应和分享，避免过度提问。
```

### 方案2: 在 prompt 中明确限制
**文件**: `app/lats/reply_planner.py`
在 system_prompt 中添加：
```python
【关于提问的约束】
- 仅在用户输入不完整、有歧义或明确需要澄清时才提问
- 用户已完整表达观点时，优先回应、共情、分享，避免追加提问
- 不要为了"保持对话"而强制提问
```

### 方案3: 调整 stage allowed_acts
**文件**: `app/lats/requirements.py`
将 `question` 从默认 allowed_acts 中移除，仅在特定场景下添加：
```python
"initiating": (
    ["answer", "clarify", "light_tease", "small_talk"],  # 移除 question
    ["deep_probe", "commitment_push", "intimacy_escalate"],
),
```

### 方案4: 添加提问频率控制
在 requirements 中添加新字段：
```python
"question_frequency": "low",  # low/medium/high
"max_questions_per_reply": 0,  # 每条回复最多提问数
```

## 📊 影响评估

- **当前影响**: 高 - 每次回复都有反问，显得过于主动
- **修复难度**: 中 - 需要修改多个配置文件和 prompt
- **风险**: 低 - 修改后可以逐步测试和调整

## 🎯 推荐行动

1. **立即**: 修改 `normal_mode.yaml` 中的 mode_behavior_targets，明确限制提问场景
2. **短期**: 在 reply_planner prompt 中添加提问约束
3. **中期**: 根据测试结果调整 stage allowed_acts 和提问频率控制
